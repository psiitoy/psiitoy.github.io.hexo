---
layout: post
title: "分布式数据库"
date: 2017-03-22 21:15:06 
description: "分布式数据库"
categories: 
    - db
tags:
    - db
---

分布式数据库

<!--more-->

- 目录
    1) 基本概念
    2) 分片
    3) 分组
    4) 实战

## 1、基本概念

###1.1 谈数据库分片需要首先确定以下概念

-   1) 单库,就是一个库
![图 danku](/img/blog/sharding/danku.png)

    2) 分片(sharding)，分片解决`扩展性`问题，属于水平拆分，引入分片，就引入了`数据路由`和`分区键`的概念。分表解决的是数据量过大的问题，分库解决的是数据库性能瓶颈的问题。
![图 fenpian](/img/blog/sharding/fenpian.jpg)

    3) 分组(group)，分组解决`可用性`问题，分组通常通过主从复制(`replication`)的方式实现。(各种可用级别方案单独介绍)
![图 fenzu](/img/blog/sharding/fenzu.jpg)

    4) 互联网公司数据库实际软件架构是(`大数据量下`)：又分片，又分组（如下图）
    
![图 fenzu+fenpian](/img/blog/sharding/fenzu+fenpian.jpg)

## 2、分片

### 2.1 水平拆分，垂直拆分都是什么？

![图 fenpianleixing](/img/blog/sharding/swdt/fenpianleixing.png)

### 2.2 为什么分表?

关系型数据库在大于一定数据量的情况下检索性能会急剧下降。在面对互联网海量数据情况时，所有数据都存于一张表，显然会轻易超过数据库表可承受的`数据量阀值`。这个单表可承受的数据量阀值，需根据数据库和并发量的差异，通过实际测试获得。

### 2.3 为什么分库?

单纯的分表虽然可以解决数据量过大导致检索变慢的问题，但无法解决过多并发请求访问同一个库，导致数据库响应变慢的问题。所以通常`水平拆分都至少要采用分库`的方式，用于一并解决大数据量和`高并发`的问题。这也是部分开源的分片数据库中间件只支持分库的原因。

### 2.4 分布式事务？

但分表也有不可替代的适用场景。最常见的分表需求是事务问题。同在一个库则不需考虑分布式事务，善于使用同库不同表可有效避免分布式事务带来的麻烦。目前强一致性的分布式事务由于性能问题，导致使用起来并不一定比不分库分表快。目前采用最终一致性的柔性事务居多。分表的另一个存在的理由是，过多的数据库实例不利于运维管理。

### 2.5 小结

综上所述，最佳实践是合理地配合使用分库+分表。

### 2.6 如何自己实现分库分表？

-   1) dao层，首先通过分区键算出库名表名(如shardKey%shardNum 算出来表index如y，然后y/(shardNum/sourceNum)=x,y是表下标，x是库下标)。
    2) 把source从spring容器中拿出来，把表名当参数传进去，拼成分片后的sql。
    3) 思路大概是(select ... from order where ... -> 先拿到db_x的source 然后 select ... from order_y where ...) 

> 你想这么干？你已经成功了。当然淘宝和当当的架构师也是这么干的。

### 2.7 SO，不需要我们亲自动手，其实你需要做的只是按照实际需求挑选而已。

![图 shardingpstrategy](/img/blog/sharding/swdt/shardingproduct.png)

### 2.8 重点介绍两个产品，先不说具体配置，只说思想

1) sharding-jdbc（所处位置，通用数据访问层，部署在客户端的jar包，用于将用户的SQL路由到指定的数据库中）

![图 shardingjdbcjiagou](/img/blog/sharding/sjdbc/shardingjdbcjiagou.png)
![图 shardingjdbcxml](/img/blog/sharding/sjdbc/shardingjdbcxml.png)

2) jproxy

> jproxy是什么？

jproxy提供MariaDB, MySQL等数据库的统一接入访问，拥有流量过载保护，数据自动拆分，可配置路由规则，数据无缝迁移等功能。
应用场景：数据需要分库分表，自动扩容的应用。

![图jproxy架构](/img/blog/dbproxy/jproxy-1.png)

#### 演变过程 cobar->mycat->jproxy

> mycat是什么?

简单的说，就是：一个彻底开源的，面向企业应用开发的“大数据库集群”。支持事务、ACID、可以替代Mysql的加强版数据库，一个的数据库中间件产品。
- 其优势具有：
    1) 基于阿里开源的Cobar产品而研发，Cobar的稳定性、可靠性、优秀的架构和性能
    2) 拥有众多成熟的使用案例
    3) 强大的团队(其参与者都是5年以上资深软件工程师、架构师、DBA等)
    4) 开源，创新，持续更新
    
![图mycat1](/img/blog/dbproxy/mycat-1.png)
![图mycat2](/img/blog/dbproxy/mycat-2.png)

- jproxy做的调优
    1) 长sql 如 insert into tables values(...),(...)... 这样的语句若占有600左右kb，会导致proxy读却这个sql数据包很慢。
解决方案，将前端socket recivebuffer从默认值4k调整至128k

    2) 后端实例连接池是以库为单位，当后端实例上有很多库时，连接数撑爆。
解决方案，改为以实例为单位

    3) jproxy线程数设置过大，导致mysql write超市，mysql关闭后端链接，导致jproxy read到EOF异常。
解决方案，将mysql write超时设置调高，并将jproxy execute线程数改小。

## 3、分组
### 3.1 为什么分组？
分组解决`可用性`问题

### 3.2 可靠性，可用性？

#### 可靠性
可靠的是数据：例如工商银行，数据不能丢失
#### 可用性
可用的是服务：服务器不能宕机

![图mycat1](/img/blog/sharding/jiangchengyao/keyong1.png)
![图mycat1](/img/blog/sharding/jiangchengyao/keyong2.png)
![图mycat1](/img/blog/sharding/jiangchengyao/ms-1.png)
![图mycat1](/img/blog/sharding/jiangchengyao/ms-2.png)
![图mycat1](/img/blog/sharding/jiangchengyao/ms-3.png)
![图mycat1](/img/blog/sharding/jiangchengyao/ms-4.png)
![图mycat1](/img/blog/sharding/jiangchengyao/ms-5.png)


## 4、实战
### 4.1 记录一次mongo迁移mysql的过程

#### mongo怎么了？

mongo很好，只是业界并没有成熟的MongoDB运维经验，jd too。

- 迁移数据库的一个方案
    1) 中心化(统一入口)
    2) 双写(先同步写mysql如果发生异常改异步，尽量避免服务不可用)
    3) 倒库(jproxy支持通过游标形式全量遍历库-逐个表操作，可以利用其异步同步数据)
    4) 数据校验
    5) 切库提供服务
    
![图 qianku](/img/blog/sharding/anli/qianku.png)

#### 去mongo+优化方案

![图 mongo-before](/img/blog/sharding/anli/mongo-before.png)
![图 mongo-after](/img/blog/sharding/anli/mongo-after.png)

#### 压测与性能
![图 yace1](/img/blog/sharding/anli/yace1.png)
![图 yace2](/img/blog/sharding/anli/yace2.png)
![图 yace3](/img/blog/sharding/anli/yace3.png)
![图 ump1](/img/blog/sharding/anli/ump1.png)
![图 ump2](/img/blog/sharding/anli/ump2.png)

#### 去mongo任务线

| 类型 | 任务 | 备注 | 影线系统 | 风险 |
|:-----|:-------|:-------|:-------|:------|
|design|海关迁移方案设计评审|...|...|无|
|design|分库分表技术选型|jproxy|...|无|
|apply|申请迁移相关应用(辅助系统)|跑批任务|...|无|
|apply|申请mysql集群|dbs系统|...|无|
|apply|申请jproxy集群|直接找接口人|...|无|
|apply|申请es集群|esm杰斯|...|无|
|coding|trace表服务中心化|soa|center|高|
|coding|涉及trace业务逻辑梳理，全部切换中心接口|接口完全适配|platform|低|
|verify|回归测试，并线上走单验证一段时间|先预发后正式|...|高|
|coding|实现mysql版本共2个表sql映射文件|基于自主研发的generator|center|低|
|verify|mysql版本sql映射文件单元测试|基于自主研发的generator|center|低|
|coding|trace表实现基于jproxy的分库分表|128个库(主) 1主3从|center|中|
|coding|es分别按照商家id分片，保税区id分片，异步写，读开放jsf|2套集群4套索引|es|中|
|coding|中心接口加入代理层，可利用开关切换读mongo/mysql/es|...|center|高|
|coding|异步补偿mongo,mysql,es功能开发|基于jmq|platform|中|
|coding|代理层实现mongo和mysql版本互为主被双写(mongo主)，异步写es|双11后mysql主|center|高|
|verify|线上开双写(包括es)|两套es集群|...|中|
|coding|倒库功能开发，数据校验功能开发|reactor|config|高|
|verify|倒库，并进行数据校验|校验规则(特殊字段不校验)|...|高|
|verify|对中心接口进行压测|线上，压测环境隔离(jsf别名)|...|高|
|coding|优化配置(mysql调整最大连接数,es使用filterCache)|...|...|高|
|verify|对中心接口进行压测|...|...|高|
|verify|升级后架构正式上线|...|...|无|
|verify|监控切换mysql之后的接口性能|...|...|无|
|verify|监控切换mysql之后对相关依赖系统的影响|...|...|无|
|todo|停mongo写|...|...|无|
|todo|继续迁移海关mongo中其他表(以上均为trace表)|...|...|无|
|todo|彻底下线mongo数据库服务器，只保留mysql服务器|...|...|无|

### 4.2 记录一次异构具有复杂分片规则数据库的过程（进行中）

#### 难点

交易库存复杂的分片规则，数据量大，更新频繁，一致性保证。
![图 kucuntouminghua](/img/blog/sharding/anli/kucuntouminghua.png)

#### 如何接手一个复杂分片规则的数据库？

#### 有多复杂?

6000+表，28个库，4套分片规则。

#### 解决方案 sharding-jdbc

![图sjdbc-1](/img/blog/dbproxy/sjdbc-1.png)
![图sjdbc-2](/img/blog/dbproxy/sjdbc-2.png)

#### 未完待续